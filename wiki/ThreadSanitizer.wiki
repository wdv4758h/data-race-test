#summary ThreadSanitizer is a Valgrind-based detector of data races
#labels Featured

<wiki:toc max_depth="1" />


= Introduction =

*!ThreadSanitizer* (aka *tsan*) is a data race detector based on [http://www.valgrind.org Valgrind]. <BR>
!ThreadSanitizer is similar to [http://valgrind.org/docs/manual/hg-manual.html Helgrind] in many ways, but it also has several 
[ThreadSanitizerVsOthers differences]. <BR>
The instrumentation code is partially taken from Helgrind; 
the [ThreadSanitizerAlgorithm race detection machinery] is new (the code is written in C++). <BR>
The source code is published under GPLv2+.

!ThreadSanitizer is being actively developed and used at [http://www.google.com Google].

See also: 
  * ThreadSanitizerAlgorithm
  * ThreadSanitizerIgnores
  * ThreadSanitizerVsOthers
  * UnderstandingThreadSanitizerReports
  * RacecheckUnittest
  * DynamicAnnotations
  * RaceCheckerClass
  * RaceDetectionLinks: links to other materials related to race detection
  * PopularDataRaces
  * ThreadSanitizerOffline: offline race detector
  * ThreadSanitizerPin: [http://www.pintool.org PIN]-based variant

Contacts: *data-race-test(#)googlegroups.com*

=Supported platforms=
ThreadSanitizer is known to work on: 
  * Linux x86_64 (supports both 32- and 64-bit binaries)
  * Linux i386
  * Darwin i386 aka MacOS X 10.5. This port is slightly less mature (see ThreadSanitizerOnMacOsx)

=Binaries=
*Experimental*

We have pre-built ThreadSanitizer binaries for
  * Linux/x86_64, tested only on Ubuntu 8.04.
  * MacOS X 10.5
The binary is a shell script that extracts itself into /tmp/valgrind.XXXXXX and executes ThreadSanitizer.
{{{
# Linux x86_64: 
wget http://data-race-test.googlecode.com/svn/trunk/tsan_binary/Linux-x86_64/tsan-self-contained.sh
# Mac OS
# wget http://data-race-test.googlecode.com/svn/trunk/tsan_binary/Darwin-i386/tsan-self-contained.sh
chmod +x ./tsan-self-contained.sh
./tsan-self-contained.sh  ls /dev/null
}}}
If you don't want to use this binary, you will have to build ThreadSanitizer yourself.

=Building !ThreadSanitizer=
!ThreadSanitizer is not a part of the official valgrind distribution, so you will 
have to download valgrind and !ThreadSanitizer separately. You will also have to 
apply a small patch to valgrind. Just paste the following script into your terminal window.

{{{
# Select valgrind and VEX revisions which we used so far.
VALGRIND_REV=10886
VEX_REV=1920
TSAN_REV=1208

# This will create directory 'valgrind'.
svn co -r $VALGRIND_REV svn://svn.valgrind.org/valgrind/trunk valgrind
cd valgrind
svn up -r $VEX_REV      VEX/

# Get ThreadSanitizer. This will create directory 'tsan' and patch valgrind
svn co -r $TSAN_REV     http://data-race-test.googlecode.com/svn/trunk/tsan tsan
mkdir tsan/tests
touch tsan/tests/Makefile.am # Valgrind needs this file.
patch -p 0 < tsan/valgrind.patch
# Build the whole thing.
./autogen.sh && ./configure --prefix=`pwd`/inst && make -j 8 && make install

# Get and compile the unittests
cd ../
svn checkout -r $TSAN_REV http://data-race-test.googlecode.com/svn/trunk/unittest tsan_test
svn checkout -r $TSAN_REV http://data-race-test.googlecode.com/svn/trunk/dynamic_annotations
cd tsan_test/
make
# Check if the ThreadSanitizer works: 
cd ../
./valgrind/inst/bin/valgrind --tool=tsan --color tsan_test/racecheck_unittest 311
# You should now see the ThreadSanitizer's output, 
# like the one shown on the screenshot.
# Done!
}}}

Optional: build a self-contained binary. 
{{{
wget http://data-race-test.googlecode.com/svn/trunk/tsan_binary/mk-self-contained-tsan.sh && \
   chmod +x mk-self-contained-tsan.sh && \
   ./mk-self-contained-tsan.sh ./valgrind/inst

}}}

*Note:* valgrind crashes if linked using [http://en.wikipedia.org/wiki/Gold_(linker) gold] (see [https://bugs.kde.org/show_bug.cgi?id=193413 bug])
{{{
valgrind: mmap(0x400000, 241664) failed in UME with error 22 (Invalid argument).
valgrind: this can be caused by executables with very large text, data or bss segments.
}}}
Please make sure you don't use gold as a linker before building ThreadSanitizer.

=Using !ThreadSanitizer=
Just like any other valgrind-based tool: 
{{{
valgrind [valgrind options] --tool=tsan [tsan options] your/program [program options]
}}}


= Command line flags = 
|| Flag name || default || description ||
|| *Analysis sensitivity flags:* ||     || ThreadSanitizer can work in different modes that affect accuracy (number of detected bugs, number of false reports) and speed.||
|| --keep-history=0|1|2          || 1   ||  Keep the history of the previous accesses. By default, the stack traces of concurrent accesses are _almost_ precise. <BR> Setting this option to zero will make the tool run 10%-30% faster, but the concurrent accesses will not be printed. <BR> Use --keep-history=0 in continuous builds, and --keep-history=1 when analyzing reports. <BR> --keep-history=2 will print the exact positions of the concurrent access, but this may be VERY slow. In 99% of cases you don't need this anyway.||
||  --fast-mode=yes|no           || yes || Be faster, but miss some races (and avoid some false positives). <br> This mode is similar to [http://www.cs.washington.edu/homes/tom/pubs/eraser.pdf Eraser]'s initialization state. ||
||  --pure-happens-before=yes|no || no  || Act as a pure happens-before detector. <br> Useful if you are testing a code which has a lot of custom synchronization, e.g. message passing, which is not annotated with DynamicAnnotations. ||
||  --ignore-in-dtor=yes|no      || yes || Ignore reports with a C++ class Destructor in stack trace.||
||        *Interface flags:*     ||     || Flags that affect the generated output. ||
||  --color                      ||  no || Add colors to the output using [http://en.wikipedia.org/wiki/ANSI_escape_code ANSI escape codes]. ||
||  --show-pc                    || no  || Show pc (program counter) in the stack traces. ||
||  --announce-threads           || no  || Show the the stack traces of thread creation . ||
||  --file-prefix-to-cut=file_prefix || ||   Remove `"^.*file_prefix"` from the printed file names.  You may pass this flag several times. ||
|| *Resource usage* || || ||
|| --max-sid ||8388608 (2^23) || This number of unique Segment IDs. <BR> This reflects the amount of memory allocated by !ThreadSanitizer at startup. One Segment ID requires ~100 bytes of memory, so by default approximately 800M of memory is allocated.<BR> The higher this number the better. This number can not be very small (<100000). The upper bound depends on the amount of available memory.  ||
|| --num-callers-in-history || 10 || The size of the stack trace stored for the concurrent accesses. <br> Increasing this number improves the reports and increases the memory footprint. ||
|| *Profiling* || || ||
|| --sample-events=N || 0 ||  If non zero, !ThreadSanitizer will sample one of 2^N events and at the end print the event profile. <br> This options could be used together with ThreadSanitizerIgnores. ||

= Screenshot= 
!ThreadSanitizer's output viewed in [http://www.vim.org vim] with syntax highlightning and the [RacecheckUnittest source code] in the second window: 

 http://data-race-test.googlecode.com/svn/trunk/images/tsan-in-vim3.png